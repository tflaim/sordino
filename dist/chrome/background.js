import{u as r}from"./chunks/storage-DpxcWYbS.js";import{s as i,g as u,f as d}from"./chunks/schedule-CZeAsn2e.js";const l=3,S=300*1e3;function p(s,e){try{const n=new URL(s).hostname.replace(/^www\./,"");for(const a of e.categories)if(a.enabled){for(const c of a.sites)if(n===c||n.endsWith(`.${c}`))return!0}for(const a of e.customSites){const c=a.replace(/^www\./,"");if(n===c||n.endsWith(`.${c}`))return!0}return!1}catch{return!1}}async function o(){const s=new Date().toISOString().split("T")[0];return r(e=>e.bypassState.lastResetDate!==s?{...e,bypassState:{quickBypassesUsed:0,lastResetDate:s,activeBypass:null},stats:{date:s,blocksTriggered:0,bypassesUsed:0}}:e)}function y(s,e){const t=e.bypassState.activeBypass;if(!t||Date.now()>t.expiresAt)return!1;try{const a=new URL(s).hostname.replace(/^www\./,"");return a===t.site||a.endsWith(`.${t.site}`)}catch{return!1}}function b(s){try{return new URL(s).hostname.replace(/^www\./,"")}catch{return s}}chrome.runtime.onMessage.addListener((s,e,t)=>(f(s).then(t),!0));async function f(s){const e=await o();switch(s.type){case"GET_BLOCK_STATUS":{const t=i(e);if(!t.shouldBlock)return{isBlocked:!1};if(!p(s.url,e))return{isBlocked:!1};if(y(s.url,e))return{isBlocked:!1};await r(a=>({...a,stats:{...a.stats,blocksTriggered:a.stats.blocksTriggered+1}}));const n=u(e.schedules);return{isBlocked:!0,reason:t.reason,timeRemaining:n?`until ${d(n)}`:void 0,bypassesRemaining:l-e.bypassState.quickBypassesUsed}}case"USE_BYPASS":{const t=l-e.bypassState.quickBypassesUsed;if(t<=0)return{success:!1,remaining:0};const n=b(s.site);return await r(a=>({...a,bypassState:{...a.bypassState,quickBypassesUsed:a.bypassState.quickBypassesUsed+1,activeBypass:{site:n,expiresAt:Date.now()+S}},stats:{...a.stats,bypassesUsed:a.stats.bypassesUsed+1}})),{success:!0,remaining:t-1}}case"GET_SETTINGS":return e;case"TOGGLE_MANUAL_OVERRIDE":return await r(t=>({...t,blockState:{...t.blockState,manualOverride:s.state,pausedUntil:null}})),{success:!0};case"PAUSE_BLOCKING":return await r(t=>({...t,blockState:{...t.blockState,pausedUntil:s.until}})),{success:!0};default:return{error:"Unknown message type"}}}chrome.alarms.create("checkSchedule",{periodInMinutes:1});chrome.alarms.onAlarm.addListener(async s=>{if(s.name==="checkSchedule"){const e=await o(),t=i(e);await r(n=>({...n,blockState:{...n.blockState,isBlocking:t.shouldBlock,activeSchedule:t.reason??null}})),e.bypassState.activeBypass&&Date.now()>e.bypassState.activeBypass.expiresAt&&await r(n=>({...n,bypassState:{...n.bypassState,activeBypass:null}}))}});chrome.runtime.onInstalled.addListener(async()=>{const s=await o(),e=i(s);await r(t=>({...t,blockState:{...t.blockState,isBlocking:e.shouldBlock,activeSchedule:e.reason??null}}))});console.log("Sordino background service worker initialized");
